---
title: "Análisis de sensibilidad Anchoveta Centro-sur"
lang: es
toc: TRUE
output: 
    pdf_document:
header-includes:
- \usepackage{draftwatermark}
- \SetWatermarkText{}
- \usepackage{fancyhdr}
- \usepackage{graphicx}
- \usepackage{parskip}
- \usepackage{caption}
- \captionsetup[table]{name=\textbf{Tabla},labelsep=period}
- \captionsetup[figure]{name=\textbf{Figura},labelsep=period}
- \captionsetup{justification=justified,format=plain,font=small,labelfont=bf,margin=50pt}
- \pagestyle{fancy}
- \usepackage{geometry}
- \geometry{top=1.5cm, bottom=1cm, left=2.5cm, right=2.5cm}
- \usepackage{helvet}
- \renewcommand{\familydefault}{\sfdefault}
- \renewcommand{\baselinestretch}{1.25}
- \newcommand{\sietepuntos}{\fontsize{7pt}{\baselineskip}\selectfont}
- \newcommand{\cincopuntos}{\fontsize{6pt}{\baselineskip}\selectfont}

- \addtolength{\headheight}{4.5\baselineskip}
- \setlength{\headheight}{70pt}
- \setlength{\footskip}{5pt}
- \setlength{\textheight}{658pt}
- \fancyhead[CO,CE]{\includegraphics[height=1.5cm]{logoifop.png}\\ \sietepuntos INSTITUTO DE FOMENTO PESQUERO / DIVISION INVESTIGACION PESQUERA}
- \fancyhead[LO,LE]{ }
- \fancyhead[RO,RE]{ }
- \renewcommand{\headrulewidth}{0.5pt}
- \fancyfoot[C]{\cincopuntos \thepage \\ \vspace{-0.2cm} ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \\ \vspace{-0.2cm} \cincopuntos CONVENIO DE DESEMPEÑO 2020 IFOP/SUBSECRETARÍA DE ECONOMíA Y EMT \\ \vspace{-0.1cm} SEGUNDO INFORME. SARDINA COMÚN DE LA  REGIÓN DE VALPARAÍSO A LA REGIÓN DE LOS LAGOS, 2021. \textbf{ANEXO I}.}
---

\pagebreak

## Sensibilidad a los coeficientes de variación de los índices de cruceros acústicos y crucero de huevos

```{r llama codigos, warning=F, include=T, message=F, echo=FALSE}
library(knitr) # para generar reporte Rmarkdown
library(stringr)
library(reshape) 
library(dplyr) 
library(ggplot2)
library(ggthemes) # para ggplot
library(patchwork) # para unir gráficos de ggplot
library(strucchange) # libreria utilizada para análisis de quiebres

dir.Fig     <-"Figuras/" # carpeta de las figuras utilizadas y generadas en este estudio
fig         <-c("pdf") # formato de figuras generadas por este código
dir.0       <-getwd() # directorio de trabajo 
dir.1       <-paste(dir.0,"/codigos_admb",sep="") # carpeta de códigos ADMB 
dir.fun     <-paste(dir.0,"/funciones/",sep="") # carpeta de funciones utilizadas en este informe
source(paste(dir.fun,"functions.R",sep="")) # funciones para leer .dat y .rep
source(paste(dir.fun,"Fn_PBRs.R",sep="")) # funciones para leer .dat y .rep
ant <-reptoRlist(paste(dir.0,"/DatosEntrada.dat",sep=""))  # datos utilizados para antecedentes


```

```{r CORRE MODELO BASE SEPTIEMBRE, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
setwd(dir.1)
#Asesoría de septiembre
system("~/admb-12.2/admb MAE0920b")
system("./MAE0920b")
```

```{r CORRE MODELO BASE MARZO, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
#Asesoría de septiembre
system("~/admb-12.2/admb MAE0321b")
system("./MAE0321b")
```

```{r  leer datos, echo=FALSE, warning=FALSE, include=T}
setwd(dir.1)

# ASESORÍA DE SEPTIEMBRE
data1        <- lisread("MAE0920b.dat") 
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data1
rep1         <- reptoRlist("MAE0920b.rep")
std1         <- read.table("MAE0920b.std",header=T,sep="",na="NA",fill=T) 

# ASESORÍA DE MARZO
data2        <- lisread("MAE0321b.dat") 
names(data2) <- str_trim(names(data2), side="right")
dat2         <- data2
rep2         <- reptoRlist("MAE0321b.rep")
std2         <- read.table("MAE0321b.std",header=T,sep="",na="NA",fill=T) 
```

```{r Actualizacion, warning=F, include=F, message=F, echo=T,eval=F}
  
  Carpeta<-"/Sensibilidad_mph"
  dir<-paste(dir.0,Carpeta,sep="")
  system<-"mac"
  admb<-"MAE0321b"
  dat_admb<-paste(admb,".dat",sep="")
  tpl_admb<-paste(admb,".tpl",sep="")

  
  setwd(dir.1)
  unlink(dir,recursive=T) #borra la carpeta creada
  dir.create(file.path(dir.0,Carpeta))#crea la carpeta nuevamente
  setwd(dir.1);file.copy(c(dat_admb,tpl_admb),dir) #copia los archivos de la carpeta creada
  
  setwd(dir) 
  data        <- lisread(paste(admb,".dat",sep="")) 
  names(data) <- str_trim(names(data), side="right")
  dat         <- data

  years<-rep2$years
  nyears<-length(years)
  #==========================================================================
  #######################     CREA Y CORRE ESCENARIOS #####################
  #==========================================================================
  setwd(dir)
  #--------------
  # escenario 1: Caso 1 Igual al caso base
  #--------------
  dat<- data
  writeData(paste(admb,"s",1,".dat",sep=""), dat, append=FALSE)
  ###########################################################################
  # **Actualización 2020**
  ###########################################################################
  #--------------
  # escenario 2: CV de mpdh = 0.3
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  writeData(paste(admb,"s",2,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 3: CV de crucero pelaces = 0.25
  #--------------
  dat<- data
  dat$Ind[,5] <- rep(0.25,nyears)
  writeData(paste(admb,"s",3,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 4: CV de crucero reclas = 0.15
  #--------------
  dat<- data
  dat$Ind[,3] <- rep(0.15,nyears)
  writeData(paste(admb,"s",4,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 5: CV de crucero mpdh = 0.3, CV pelaces = 0.25
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  dat$Ind[,5] <- rep(0.25,nyears)
  writeData(paste(admb,"s",5,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 6: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  dat$Ind[,5] <- rep(0.25,nyears)
  dat$Ind[,3] <- rep(0.15,nyears)
  writeData(paste(admb,"s",6,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 7: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  dat$Ind[,5] <- rep(0.3,nyears)
  dat$Ind[,3] <- rep(0.3,nyears)
  dat$Ind[,6] <- c(rep(0,5),112000,148000,153000,721000,0,182000,411000,85000,105000,0,51000,18000,17000,60000,28000,0,208000,137000,643000,0)
  writeData(paste(admb,"s",7,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 8: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  dat$Ind[,5] <- rep(0.25,nyears)
  dat$Ind[,3] <- rep(0.15,nyears)
  dat$Ind[,6] <- c(rep(0,5),112000,148000,153000,721000,0,182000,411000,85000,105000,0,51000,18000,17000,60000,28000,0,208000,137000,643000,0)
  writeData(paste(admb,"s",8,".dat",sep=""), dat, append=FALSE)
  
  
  #--------------
  # escenario 9: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº1 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  dat$Ind[,5] <- rep(0.25,nyears)
  dat$Ind[,3] <- rep(0.15,nyears)
  dat$Ind[,6] <- c(rep(0,5),139.6,508,285.6,597.5,1994.3,429.4,149,492.4,188.9,43,81.3,247.2,469.2,244.7,0,0,0,0,0,0)
  writeData(paste(admb,"s",9,".dat",sep=""), dat, append=FALSE)
  
  
  #--------------
  # escenario 10: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº2 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  dat$Ind[,5] <- rep(0.25,nyears)
  dat$Ind[,3] <- rep(0.15,nyears)
  dat$Ind[,6] <- c(rep(0,5),694,2568,1285,2283,6214,1410,496,1934,841,199,363,983,0,0,0,0,0,0,0,0)
  writeData(paste(admb,"s",10,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 11: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº3
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  dat$Ind[,5] <- rep(0.25,nyears)
  dat$Ind[,3] <- rep(0.15,nyears)
  dat$Ind[,6] <- c(rep(0,5),1.31,0,1.73,4.02,25.49,2.39,1.14,3.72,1.35,0.12,0.34,1.69,0,0,0,0,0,0,0,0)
  writeData(paste(admb,"s",11,".dat",sep=""), dat, append=FALSE)
  
  
  #--------------
  # escenario 12: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº4
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,nyears)
  dat$Ind[,5] <- rep(0.25,nyears)
  dat$Ind[,3] <- rep(0.15,nyears)
  dat$Ind[,6] <- c(rep(0,5),6.5,0,7.77,15.35,79.43,7.84,3.79,14.63,6,0.54,1.52,6.72,0,0,0,0,0,0,0,0)
  writeData(paste(admb,"s",12,".dat",sep=""), dat, append=FALSE)
  
  
  
  for(i in 1:12){
  setwd(dir.1);  file.copy(c(paste(admb,".tpl",sep="")),dir)
  setwd(dir);  file.rename(paste(admb,".tpl",sep=""),paste(admb,"s",i,".tpl",sep=""))
  
  if(system=="mac"){
    system(paste("~/admb-12.2/admb ",admb,"s",i,sep=""))
    system(paste("./",admb,"s",i,sep="")) }
  
  if(system=="windows"){
    system(paste("admb ",admb,"s",i,sep=""))
    system(paste(admb,"s",i,sep="")) }
  
  file.remove(paste(admb,"s",i,".htp", sep=""),
              paste(admb,"s",i,".cpp", sep=""),
              paste(admb,"s",i,".obj", sep=""),
              paste(admb,"s",i,".p01", sep=""),
              paste(admb,"s",i,".b01", sep=""),
              paste(admb,"s",i,".r01", sep=""),
              paste(admb,"s",i,".p02", sep=""),
              paste(admb,"s",i,".b02", sep=""),
              paste(admb,"s",i,".r02", sep=""),
              paste(admb,"s",i,".p03", sep=""),
              paste(admb,"s",i,".b03", sep=""),
              paste(admb,"s",i,".r03", sep=""),
              paste(admb,"s",i,".p04", sep=""),
              paste(admb,"s",i,".b04", sep=""),
              paste(admb,"s",i,".r04", sep=""),
              paste(admb,"s",i,".p05", sep=""),
              paste(admb,"s",i,".b05", sep=""),
              paste(admb,"s",i,".r05", sep=""),
              paste(admb,"s",i,".p06", sep=""),
              paste(admb,"s",i,".b06", sep=""),
              paste(admb,"s",i,".r06", sep=""),
              paste(admb,"s",i,".p07", sep=""),
              paste(admb,"s",i,".b07", sep=""),
              paste(admb,"s",i,".r07", sep=""),
              paste(admb,"s",i,".p08", sep=""),
              paste(admb,"s",i,".b08", sep=""),
              paste(admb,"s",i,".r08", sep=""),
              paste(admb,"s",i,".par", sep=""),
              paste(admb,"s",i,".bar", sep=""),
              paste(admb,"s",i,".eva", sep=""),
              paste(admb,"s",i,".cor", sep=""),
              paste(admb,"s",i,".log", sep=""),
              paste(admb,"s",i,".tpl", sep=""),
              paste(admb,"s",i,".exe", sep=""))
  
  }
  
```

\small

+------------+------------------------------------------------------------------------------------------+
| Escenarios | Descripción                                                                              |
+============+==========================================================================================+
| S1         | igual a caso base                                                                        |
+------------+------------------------------------------------------------------------------------------+
| S2         | cambia CV MPDH a 0.3                                                                     |
+------------+------------------------------------------------------------------------------------------+
| S3         | cambia CV crucero otoño a 0.25                                                           |
+------------+------------------------------------------------------------------------------------------+
| S4         | cambia CV crucero verano a 0.15                                                          |
+------------+------------------------------------------------------------------------------------------+
| S5         | cambia CV mpdh 0.3 y CV crucero otoño a 0.25                                             |
+------------+------------------------------------------------------------------------------------------+
| S6         | cambia CV mpdh 0.3, CV crucero otoño a 0.25 y CV crucero verano 0.15                     |
+------------+------------------------------------------------------------------------------------------+
| S7         | índice MPDH actualizado, CV mpdh 0.3, CV crucero otoño a 0.30 y CV crucero verano 0.30   |
+------------+------------------------------------------------------------------------------------------+
| S8         | índice MPDH actualizado, CV mpdh 0.3, CV crucero otoño a 0.25 y CV crucero verano 0.15   |
+------------+------------------------------------------------------------------------------------------+
| S9         | CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº1 |
+------------+------------------------------------------------------------------------------------------+
| S10        | CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº2 |
+------------+------------------------------------------------------------------------------------------+
| S11        | CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº3 |
+------------+------------------------------------------------------------------------------------------+
| S12        | CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº4 |
+------------+------------------------------------------------------------------------------------------+
|            |                                                                                          |
+------------+------------------------------------------------------------------------------------------+

: Escenarios de sensibilidad respecto a coeficientes de variación (CV) de cruceros acústicos y mpdh

```{r dataindices,warning=F, include=T, message=F, echo=F }

yrs   <- rep2$years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvBcV   <-0.30
cvBcO   <-0.30
cvBcH   <-0.30
cvdes   <-0.01

Carpeta<-"/Sensibilidad_mph/"
  dir<-paste(dir.0,Carpeta,sep="")
admb<-"MAE0321b"
#######################################################################################

years       <- rep2$years
nyears      <- length(years)
retros      <- seq(1,12)
nretros     <- length(retros)

                      
retroRecl    <- matrix(0,nrow=nyears,ncol=nretros)
retroPel     <- matrix(0,nrow=nyears,ncol=nretros)
retroMph     <- matrix(0,nrow=nyears,ncol=nretros)
retroDes     <- matrix(0,nrow=nyears,ncol=nretros)


for(i in 1:(nretros)){
  rep <- reptoRlist(paste(dir,admb,"s",i,".rep",sep=""))
  retroRecl[,i]  <- c(rep$reclaspred)
  retroPel[,i]   <- c(rep$pelacespred)
  retroMph[,i]   <- c(rep$mphpred)
  retroDes[,i]   <- c(rep$desembarquepred)
}



ind_obs             <- cbind(c(rep2$reclasobs),
                             c(rep2$pelacesobs),
                             c(c(rep(0,5),112000,148000,153000,721000,0,182000,411000,85000,105000,0,51000,18000,17000,60000,28000,0,208000,137000,643000,0)),
                             c(rep2$desembarqueobs))
ind_obs[ind_obs==0] <- NA
colnames(ind_obs)   <- c('Crucero_verano', 
                         'Crucero_otoño',
                         'Crucero_huevos', 
                         'Desembarques') 

ind               <- data.frame(ind_obs) %>% 
                     mutate(Series='observado') %>% 
                     mutate (years=years) %>% 
                     melt(id.var=c('years', 'Series'))       

datR <- data.frame(years=years,
                   S1=retroRecl[,1],
                   S2=retroRecl[,2],
                   S3=retroRecl[,3],
                   S4=retroRecl[,4],
                   S5=retroRecl[,5],
                   S6=retroRecl[,6],
                   S7=retroRecl[,7],
                   S8=retroRecl[,8],
                   S9=retroRecl[,9],
                   S10=retroRecl[,10],
                   S11=retroRecl[,11],
                   S12=retroRecl[,12])%>% 
         mutate(Series=rep("Crucero_verano",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBT <- data.frame(years=years,
                   S1=retroPel[,1],
                   S2=retroPel[,2],
                   S3=retroPel[,3],
                   S4=retroPel[,4],
                   S5=retroPel[,5],
                   S6=retroPel[,6],
                   S7=retroPel[,7],
                   S8=retroPel[,8],
                   S9=retroPel[,9],
                   S10=retroPel[,10],
                   S11=retroPel[,11],
                   S12=retroPel[,12])%>% 
         mutate(Series=rep("Crucero_Otoño",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBD <- data.frame(years=years,
                   S1=retroMph[,1],
                   S2=retroMph[,2],
                   S3=retroMph[,3],
                   S4=retroMph[,4],
                   S5=retroMph[,5],
                   S6=retroMph[,6],
                   S7=retroMph[,7],
                   S8=retroMph[,8],
                   S9=retroMph[,9],
                   S10=retroMph[,10],
                   S11=retroMph[,11],
                   S12=retroMph[,12])%>% 
         mutate(Series=rep("Crucero_huevos",nyears))%>%
         melt(id.var=c('years', 'Series'))

datF <- data.frame(years=years,
                   S1=retroDes[,1],
                   S2=retroDes[,2],
                   S3=retroDes[,3],
                   S4=retroDes[,4],
                   S5=retroDes[,5],
                   S6=retroDes[,6],
                   S7=retroDes[,7],
                   S8=retroDes[,8],
                   S9=retroDes[,9],
                   S10=retroDes[,10],
                   S11=retroDes[,11],
                   S12=retroDes[,12])%>% 
         mutate(Series=rep("Desembarques",nyears))%>%
         melt(id.var=c('years', 'Series'))

data2 <- data.frame(rbind(ind,datR,datBT,datBD,datF)) 




```

```{r Fig26CCTPPjulioAnch,warning=F, include=T, message=F, echo=F,fig.height=8,fig.width=6.5,fig.align="center",fig.path=dir.Fig,dev=fig}
f1<- ggplot(data2 %>% filter(Series=="Crucero_verano"),
            aes(years,value)) +   
     geom_line(aes(colour=variable), size=0.3)+
    geom_point(data = data2 %>% filter(Series=='observado', variable=='Crucero_verano'),
       aes(years,value), shape = 19, colour = 'gray30') +
     geom_errorbar(data = data2 %>% filter(Series=='observado', variable=='Crucero_verano'),
       aes(ymin = value*exp(-1.96*cvBcV), ymax = value*exp(1.96*cvBcV)), color = 'gray30') +
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Crucero_verano')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<- ggplot(data2 %>% filter(Series=="Crucero_Otoño"),
            aes(years,value)) +   
     geom_line(aes(colour=variable), size=0.3)+
    geom_point(data = data2 %>% filter(Series=='observado', variable=='Crucero_otoño'),
       aes(years,value), shape = 19, colour = 'gray30') +
     geom_errorbar(data = data2 %>% filter(Series=='observado', variable=='Crucero_otoño'),
       aes(ymin = value*exp(-1.96*cvBcO), ymax = value*exp(1.96*cvBcO)), color = 'gray30') +
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Crucero_Otoño')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f3<- ggplot(data2 %>% filter(Series=="Crucero_huevos"),
            aes(years,value)) +   
     geom_line(aes(colour=variable), size=0.3)+
    geom_point(data = data2 %>% filter(Series=='observado', variable=='Crucero_huevos'),
       aes(years,value), shape = 19, colour = 'gray30') +
     geom_errorbar(data = data2 %>% filter(Series=='observado', variable=='Crucero_huevos'),
       aes(ymin = value*exp(-1.96*cvBcH), ymax = value*exp(1.96*cvBcH)), color = 'gray30') +
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Crucero_huevos')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")


(f1/f2/f3)


```

```{r VariablesMarzo_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep2$years
nyears<-length(years)
x  <-c(years,rev(years))

Rt2      <- subset(std2,name=="Reclutas")$value 
Rt2std   <- subset(std2,name=="Reclutas")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="SSB")$value   
BD2std   <- subset(std2,name=="SSB")$std
Ft2      <- subset(std2,name=="log_Ft")$value   
Ft2std   <- subset(std2,name=="log_Ft")$std

VarPob<- data.frame(x=years, 
                    Rt2=Rt2,
                    BT2=BT2,
                    BD2=BD2,
                    Ft2=exp(Ft2), 
         lowerRt2 = (Rt2 -1.96*Rt2std), 
         upperRt2 = (Rt2+1.96*Rt2std),
         lowerBT2 = (BT2 -1.96*BT2std),
         upperBT2 = (BT2+1.96*BT2std),
         lowerBD2 = (BD2 -1.96*BD2std), 
         upperBD2 = (BD2+1.96*BD2std),
         lowerFt2 = exp(Ft2 -1.96*Ft2std), 
         upperFt2 = exp(Ft2+1.96*Ft2std))

```

```{r variables, echo=F,message=FALSE, warning=FALSE, include=T}

Carpeta<-"/Sensibilidad_mph/"
  dir<-paste(dir.0,Carpeta,sep="")


admb<-"MAE0321b"
#######################################################################################

years       <- rep2$years
nyears      <- length(years)
retros      <- seq(1,12)
nretros     <- length(retros)

                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros)
retroBT     <- matrix(0,nrow=nyears,ncol=nretros)
retroF      <- matrix(0,nrow=nyears,ncol=nretros)


for(i in 1:(nretros)){
  rep <- reptoRlist(paste(dir,admb,"s",i,".rep",sep=""))
  retroR[,i]  <- c(rep$Reclutas)
  retroBD[,i] <- c(rep$SSB)
  retroBT[,i] <- c(rep$BT)
  retroF[,i]  <- c(rep$Ftot) 
}


# Diferencia relativa con caso base actual 
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    rel.diff.bt  <- matrix(NA, nrow=nyears, ncol=(nretros))
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))
    
    
    for(j in 1:nretros){
      rel.diff.r[,j]          <- (retroR[,(j)]-retroR[,1])/retroR[,1]
      rel.diff.ssb[,j]        <- (retroBD[,(j)]-retroBD[,1])/retroBD[,1]
      rel.diff.bt[,j]         <- (retroBT[,(j)]-retroBT[,1])/retroBT[,1]
      rel.diff.f[,j]          <- (retroF[,(j)]-retroF[,1])/retroF[,1]
    }
    
    
```

```{r data1, echo=F,message=FALSE, warning=FALSE, include=T}

datR <- data.frame(years=years,
                   S1=retroR[,1],
                   S2=retroR[,2],
                   S3=retroR[,3],
                   S4=retroR[,4],
                   S5=retroR[,5],
                   S6=retroR[,6],
                   S7=retroR[,7],
                   S8=retroR[,8],
                   S9=retroR[,9],
                   S10=retroR[,10],
                   S11=retroR[,11],
                   S12=retroR[,12])%>% 
         mutate(Series=rep("Reclutamientos",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBT <- data.frame(years=years,
                   S1=retroBT[,1],
                   S2=retroBT[,2],
                   S3=retroBT[,3],
                   S4=retroBT[,4],
                   S5=retroBT[,5],
                   S6=retroBT[,6],
                   S7=retroBT[,7],
                   S8=retroBT[,8],
                   S9=retroBT[,9],
                   S10=retroBT[,10],
                   S11=retroBT[,11],
                   S12=retroBT[,12])%>% 
         mutate(Series=rep("Biomasa_total",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBD <- data.frame(years=years,
                   S1=retroBD[,1],
                   S2=retroBD[,2],
                   S3=retroBD[,3],
                   S4=retroBD[,4],
                   S5=retroBD[,5],
                   S6=retroBD[,6],
                   S7=retroBD[,7],
                   S8=retroBD[,8],
                   S9=retroBD[,9],
                   S10=retroBD[,10],
                   S11=retroBD[,11],
                   S12=retroBD[,12])%>% 
         mutate(Series=rep("Biomasa_desovante",nyears))%>%
         melt(id.var=c('years', 'Series'))

datF <- data.frame(years=years,
                   S1=retroF[,1],
                   S2=retroF[,2],
                   S3=retroF[,3],
                   S4=retroF[,4],
                   S5=retroF[,5],
                   S6=retroF[,6],
                   S7=retroF[,7],
                   S8=retroF[,8],
                   S9=retroF[,9],
                   S10=retroF[,10],
                   S11=retroF[,11],
                   S12=retroF[,12])%>% 
         mutate(Series=rep("Mortalidad_por_pesca",nyears))%>%
         melt(id.var=c('years', 'Series'))

data1 <- data.frame(rbind(datR,datBT,datBD,datF)) 



```

```{r Fig1CCTPPjulioAnch,echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=6, fig.width=8,fig.path=dir.Fig,dev=fig}
#######################################################################################
# GRAFICAS
#######################################################################################
f1<- ggplot(data1 %>% filter(Series=="Reclutamientos")) +   
     geom_line(aes(years,value,colour=variable), size=0.3)+
     geom_ribbon(data=VarPob,aes(ymin=lowerRt2, ymax=upperRt2, x=x, fill = "IC"), alpha = 0.2)+
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Reclutamientos')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<- ggplot(data1 %>% filter(Series=="Biomasa_total")) +  
     geom_line(aes(years,value,colour=variable), size=0.3)+
     geom_ribbon(data=VarPob,aes(ymin=lowerBT2, ymax=upperBT2, x=x, fill = "IC"), alpha = 0.2)+
     labs(x = '', y = 'toneladas',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Biomasa total')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f3<- ggplot(data1 %>% filter(Series=="Biomasa_desovante")) +  
     geom_line(aes(years,value,colour=variable), size=0.3)+
     geom_ribbon(data=VarPob,aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = "IC"), alpha = 0.2)+
     labs(x = '', y = 'toneladas',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Biomasa desovante')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="left")

f4<- ggplot(data1 %>% filter(Series=="Mortalidad_por_pesca")) +
     geom_line(aes(years,value,colour=variable), size=0.3)+
     geom_ribbon(data=VarPob,aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = "IC"), alpha = 0.2)+
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Mortalidad por pesca')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

(f1/f2) | (f3/f4)
```

```{r diferencias, echo=F,message=FALSE, warning=FALSE, include=T}

datR <- data.frame(years=years,
                   S1=rel.diff.r[,1],
                   S2=rel.diff.r[,2],
                   S3=rel.diff.r[,3],
                   S4=rel.diff.r[,4],
                   S5=rel.diff.r[,5],
                   S6=rel.diff.r[,6],
                   S7=rel.diff.r[,7],
                   S8=rel.diff.r[,8], 
                   S9=rel.diff.r[,9], 
                   S10=rel.diff.r[,10],
                   S11=rel.diff.r[,11])%>% 
         mutate(Series=rep("Reclutamientos",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBT <- data.frame(years=years,
                   S1=rel.diff.bt[,1],
                   S2=rel.diff.bt[,2],
                   S3=rel.diff.bt[,3],
                   S4=rel.diff.bt[,4],
                   S5=rel.diff.bt[,5],
                   S6=rel.diff.bt[,6],
                   S7=rel.diff.bt[,7],
                   S8=rel.diff.bt[,8],
                   S9=rel.diff.bt[,9],
                   S10=rel.diff.bt[,10],
                   S11=rel.diff.bt[,11])%>% 
         mutate(Series=rep("Biomasa_total",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBD <- data.frame(years=years,
                   S1=rel.diff.ssb[,1],
                   S2=rel.diff.ssb[,2],
                   S3=rel.diff.ssb[,3],
                   S4=rel.diff.ssb[,4],
                   S5=rel.diff.ssb[,5],
                   S6=rel.diff.ssb[,6],
                   S7=rel.diff.ssb[,7],
                   S8=rel.diff.ssb[,8],
                   S9=rel.diff.ssb[,9],
                   S10=rel.diff.ssb[,10],
                   S11=rel.diff.ssb[,11])%>% 
         mutate(Series=rep("Biomasa_desovante",nyears))%>%
         melt(id.var=c('years', 'Series'))

datF <- data.frame(years=years,
                   S1=rel.diff.f[,1],
                   S2=rel.diff.f[,2],
                   S3=rel.diff.f[,3],
                   S4=rel.diff.f[,4],
                   S5=rel.diff.f[,5],
                   S6=rel.diff.f[,6],
                   S7=rel.diff.f[,7],
                   S8=rel.diff.f[,8],
                   S9=rel.diff.f[,9],
                   S10=rel.diff.f[,10],
                   S11=rel.diff.f[,11])%>% 
         mutate(Series=rep("Mortalidad_por_pesca",nyears))%>%
         melt(id.var=c('years', 'Series'))

data <- data.frame(rbind(datR,datBT,datBD,datF)) 



```

```{r Fig2,echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=6, fig.width=8,fig.path=dir.Fig,dev=fig,eval=F}
#######################################################################################
# GRAFICAS
#######################################################################################
f1<- ggplot(data %>% filter(Series=="Reclutamientos"),
            aes(years,value)) +   ylim(-0.30, 0.30) + 
     geom_line(aes(colour=variable), size=0.3)+
     labs(x = '', y = 'Diferencia relativa',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,11,1))+
     theme_bw(base_size=9) + 
     ggtitle('Reclutamientos')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<- ggplot(data %>% filter(Series=="Biomasa_total"),
            aes(years,value)) +   ylim(-0.30, 0.30) + 
     geom_line(aes(colour=variable), size=0.3)+
     labs(x = '', y = 'Diferencia relativa',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,11,1))+
     theme_bw(base_size=9) + 
     ggtitle('Biomasa total')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f3<- ggplot(data %>% filter(Series=="Biomasa_desovante"),
            aes(years,value)) +   ylim(-0.30, 0.30) + 
     geom_line(aes(colour=variable), size=0.3)+
     labs(x = '', y = 'Diferencia relativa',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,11,1))+
     theme_bw(base_size=9) + 
     ggtitle('Biomasa desovante')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="left")

f4<- ggplot(data %>% filter(Series=="Mortalidad_por_pesca"),
            aes(years,value)) +
      ylim(-0.30, 0.30) + 
     geom_line(aes(colour=variable), size=0.3)+
     labs(x = '', y = 'Diferencia relativa',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,11,1))+
     theme_bw(base_size=9) + 
     ggtitle('Mortalidad por pesca')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

(f1/f2) | (f3/f4)
```



\pagebreak

## Corrección de las capturas

Capturas corregidas por periodo y método en sardina común y anchoveta centro-sur. Desembarque oficial indica aquella serie de captura construida con información de SERNAPESCA descrita en este proyecto. "Prop. Encuesta" indica la proporción de corrección considerando descarte y sub-reportes solo con información desde encuestas. "Prop. Encuesta más Censura" indica la proporción resultante de combinar la información desde encuestas con el método estadístico de datos censurador. "Captura Cor." Indica la captura corregida usando las proporciones descritas. "CV" indica el coeficiente de variación de la estimación de captura corregida.



## Análisis de sardina común

```{r desembarques y descarte sardina, echo=FALSE,eval=T}
bioyear<-c("1990-91","1991-92","1992-93","1993-94","1994-95","1995-96","1996-97","1997-98","1998-99","1999-00","2000-01",
           "2001-02","2002-03","2003-04","2004-05","2005-06","2006-07","2007-08","2008-09","2009-10","2010-11","2011-12",
           "2012,13","2013-14","2014-15","2015-16","2016-17","2017-18","2018-19","2019-20","2020-21")
desemYdesc<-c(494567,514787,250237,358949,361735,120608,552515,73892,212993,205616,52469,317467,293654,387597,252695,
              516296,358380,742168,942051,627588,828172,859565,418607,520667,417249,300574,407403,355545,319650,289779,219260)
desc<-c(rep(1,10),rep(1.04,16),rep(1.02,2),rep(1.06,2),1.04)
desembarque<-desemYdesc/desc

porcDesc<-c(rep("0%",10),rep("4%",16),rep("2%",2),rep("6%",2),"4%")

data<-data.frame("Año biológico"=bioyear,
                 "Desembarques t."=round(desembarque,0),
                 "Porcentaje descarte" =porcDesc,
                 "Captura descartada t."=round(desemYdesc-desembarque,0),
                 "Captura total t."=round(desemYdesc,0))
kable(data, align = 'c')
```

\pagebreak

```{r Fig5CCTPPsard, echo=F, message=FALSE, warning=FALSE, include=T,echo=F, message=FALSE, warning=FALSE, include=T,fig.align="center", fig.height=6, fig.width=8,fig.path="Figuras/",dev="pdf",eval=T}

# Tabla 24. Capturas corregidas por período y método en sardina común

year<-seq(1990,2015,1)
desemoficial <-c(285757,564879,452012,244101,341247,126715,446669,441149,317416,781004,722465,324462,331440,300337,352626,272645,422865,271702,803891,852043,745086,894836,850170,227927,529537,430834)
propEnc      <-c(rep(0.171,7),rep(0.002,4),rep(0.186,3),rep(0.313,6),rep(0.391,3),rep(0.195,3))
propEncCens  <-c(rep(0.152,7),rep(0.025,4),rep(0.170,3),rep(0.215,6),rep(0.228,3),rep(0.150,3))

CapCorrEnc<-round((1+propEnc)*desemoficial,0)
CapCorrEncCens<-round((1+propEncCens)*desemoficial,0)

CV<-c(rep(0.194,7),rep(0.186,4),rep(0.188,3),rep(0.163,6),rep(0.169,3),rep(0.165,3))

tabla24Sard<-cbind(year,desemoficial,propEnc,propEncCens,CapCorrEnc,CapCorrEncCens,CV)
kable(tabla24Sard)


par(mfrow=c(1,1),mar=c(2,4,1,1)+0.5)
plot(seq(1990,2020,1),c(desemoficial,rep(NA,5)),type="o",col=1,pch=19,ylab="Desembarques/Capturas",xlab="Años",main="Sardina común",ylim=c(0,1250000))
lines(seq(1990,2020,1),c(CapCorrEnc,rep(NA,5)),col=2)
lines(seq(1990,2020,1),c(CapCorrEncCens,rep(NA,5)),col=4)
lines(seq(1990,2020,1),c(NA,desembarque[1:30]),col=3,lwd=2)
legend(1995,1230000,c("Desembarques oficiales","Capturas Corregidas Encuestas","Capturas Corregidas Encuestas + Censuras","Capturas Evaluación IFOP"),col=c(1,2,4,3),lwd=c(1,1,1,2),pch=c(19,NA,NA,NA),bty="n",cex=0.8)

```

\pagebreak

## Análisis de anchoveta centro-sur

```{=tex}
\small
\begin{center} 
\textbf{Tabla x.}
\end{center}
\begin{center} 
\vspace{-0.2cm} Desembarques en toneladas, porcentaje de descarte supuesto, captura descartada (toneladas) y captura total (toneladas) estimadas en año biológico para anchoveta de las Regiones de Valparaíso a Los Lagos.
\end{center}
```
```{r Fig4, echo=FALSE,eval=T,, fig.align="center", fig.height=6, fig.width=8,fig.path=dir.Fig,dev=fig}
bioyear<-c("1996-97","1997-98","1998-99","1999-00","2000-01",
           "2001-02","2002-03","2003-04","2004-05","2005-06","2006-07","2007-08","2008-09","2009-10","2010-11","2011-12",
           "2012-13","2013-14","2014-15","2015-16","2016-17","2017-18","2018-19","2019-20","2020-21")
desemYdesc<-c(350755,77701,442110,56441,14545,235359,269955,359681,431902,328805,639364,411747,362871,
              311530,167758,66681,60226,58785,57116,71774,51957,67425,138520,160799,200461)
desc<-c(rep(1,4),rep(1.04,15),rep(1.02,1),rep(1.06,1),1.01,rep(1.02,3))
desembarque<-desemYdesc/desc

porcDesc<-c(rep("0%",4),rep("4%",15),rep("2%",1),rep("6%",1),"1%",rep("2%",3))

data<-data.frame("Año biológico"=bioyear,
                 "Desembarques t."=round(desembarque,0),
                 "Porcentaje descarte" =porcDesc,
                 "Captura descartada t."=round(desemYdesc-desembarque,0),
                 "Captura total t."=round(desemYdesc,0))
kable(data, align = 'c')

```

\pagebreak

```{r Fig5, echo=F, message=FALSE, warning=FALSE, include=T,fig.align="center", fig.height=6, fig.width=8,fig.path=dir.Fig,dev=fig}

# Tabla 24. Capturas corregidas por período y método en Anchoveta

year<-seq(1990,2015,1)
desemoficial <-c(152362,268017,262257,205936,474223,256443,360828,292108,277981,1066694,447409,160464,265586,297224,352207,429485,382351,561637,391576,434636,222184,105974,74513,42292,55529,63868)
propEnc      <-c(rep(0.171,7),rep(0.010,4),rep(0.198,3),rep(0.353,6),rep(0.401,3),rep(0.173,3))
propEncCens  <-c(rep(0.233,7),rep(0.044,4),rep(0.160,3),rep(0.233,6),rep(0.381,3),rep(0.123,3))
propEncSupuesto      <-c(rep(0.171,7),rep(0.010,4),rep(0.198,3),rep(0.353,6),rep(0.401,3),rep(0.173,8))


CapCorrEnc<-round((1+propEnc)*desemoficial,0)
CapCorrEncCens<-round((1+propEncCens)*desemoficial,0)

CV<-c(rep(0.192,7),rep(0.183,4),rep(0.186,3),rep(0.160,6),rep(0.172,3),rep(0.160,3))

tabla25Anch<-cbind(year,desemoficial,propEnc,propEncCens,CapCorrEnc,CapCorrEncCens,CV)
kable(tabla25Anch)

par(mfrow=c(1,1),mar=c(2,4,1,1)+0.5)
plot(seq(1990,2020,1),c(desemoficial,rep(NA,5)),type="o",col=1,pch=19,ylab="Desembarques/Capturas",xlab="Años",main="Anchoveta Centro-sur",ylim=c(0,1250000))
lines(seq(1990,2020,1),c(CapCorrEnc,rep(NA,5)),col=2)
lines(seq(1990,2020,1),c(CapCorrEncCens,rep(NA,5)),col=4)
lines(seq(1990,2020,1),c(rep(NA,7),desembarque[1:24]),col=3,lwd=2)
legend(2002,1230000,c("Desembarques oficiales","Capturas Corregidas Encuestas","Capturas Corregidas Encuestas + Censuras","Capturas Evaluación IFOP"),col=c(1,2,4,3),lwd=c(1,1,1,2),pch=c(19,NA,NA,NA),bty="n",cex=0.8)

```
